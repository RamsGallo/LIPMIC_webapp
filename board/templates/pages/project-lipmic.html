{% extends 'base.html' %}

{% block title %}
    Corrective Tool
{% endblock title %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<!-- Tool Section -->
<section class="py-5" style="background: linear-gradient(180deg, #70C0DC 0%, #B6DFF4 100%); min-height: 100vh;">
    <div class="container">
        <h2 class="text-center fw-bold mb-5" style="color: #1e4d5c;">Corrective Tool</h2>
        <div class="row justify-content-center">
            <!-- Video Feed Column -->
            <div class="col-md-6 mb-4">
                <div class="border rounded-4 shadow-sm p-3 bg-white">
                    <img src="{{ url_for('pages.video_feed') }}" class="img-fluid rounded-3" alt="Camera Feed">
                </div>
            </div>

            <!-- Prediction & Controls Column -->
            <div class="col-md-6">
                <div class="card border-0 shadow rounded-4 bg-white text-center mb-4">
                    <div class="card-body">
                        <h4 class="fw-bold mb-3" style="color: #1E4D5C;">Current Prediction</h4>
                        <p id="current-prediction" class="lead text-success">None</p>
                        <hr>

                        <h5 class="fw-semibold mt-4 mb-2" style="color: #1E4D5C;">Evaluation Test</h5>
                        <p><strong>Select a word to practice:</strong></p>

                        <div class="d-flex gap-2 mb-3">
                            <select id="word-dropdown" class="form-control">
                                <option value="" selected disabled>Select a word</option>
                                <option>Down</option>
                                <option>Left</option>
                                <option>Right</option>
                                <option>Up</option>
                                <!-- <option>Can</option>
                                <option>Hear</option>
                                <option>Hello</option>
                                <option>Help</option>
                                <option>I</option>
                                <option>Love</option>
                                <option>Need</option>
                                <option>Please</option>
                                <option>See</option>
                                <option>Speak</option>
                                <option>Watch</option>
                                <option>We</option>
                                <option>You</option> -->
                            </select>
                            <button id="reset-dropdown-btn" class="btn btn-outline-secondary">Clear</button>
                        </div>

                        <button id="toggle-tts-btn" class="btn text-white">ðŸ”‡ Speech Off</button>
                        <audio id="ting-sound" src="https://www.myinstants.com/media/sounds/ding-sound-effect_2.mp3"></audio>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Custom CSS -->
<style>
    #toggle-tts-btn {
        background-color: gray;
        transition: background-color 0.3s ease;
    }
    .btn-speech-on {
        background-color: #3c7486 !important;
    }
    .btn-speech-off {
        background-color: gray !important;
    }
</style>

<!-- JavaScript Section -->
<script>
    let lastSpokenText = "";
    let ttsEnabled = false;
    let selectedWord = "";

    function fetchPrediction() {
        $.getJSON("{{ url_for('pages.get_prediction') }}", function(data) {
            let prediction = data.prediction || "None";
            let sentence = formatSentence(prediction);

            if (sentence !== lastSpokenText) {
                $("#current-prediction").text(sentence);
                if (ttsEnabled) speakText(sentence);
                if (selectedWord) checkPrediction(sentence);
                lastSpokenText = sentence;
            }
        });
    }

    function formatSentence(text) {
        if (!text || text.trim() === "None") return "No prediction available.";
        text = text.trim();
        return text.charAt(0).toUpperCase() + text.slice(1);
    }

    function speakText(text) {
        if (ttsEnabled && text) {
            let utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utterance);
        }
    }

    function checkPrediction(prediction) {
        let cleanPrediction = prediction.replace(/[.!?]/g, '');
        if (cleanPrediction === selectedWord) {
            document.getElementById("ting-sound").play();
            speakText("Fantastic speaking! Good job!");
            setTimeout(() => {
                $("#word-dropdown").val("");
                selectedWord = "";
            }, 1000);
        } else {
            speakText("Try again");
        }
    }

    function resetDropdown() {
        $("#word-dropdown").val("");
        selectedWord = "";
        speakText("Selection cleared.");
    }

    $("#toggle-tts-btn").click(function() {
        ttsEnabled = !ttsEnabled;

        $(this).removeClass("btn-speech-on btn-speech-off");

        if (ttsEnabled) {
            $(this).addClass("btn-speech-on").text("ðŸ”Š Speech On");
        } else {
            $(this).addClass("btn-speech-off").text("ðŸ”‡ Speech Off");
            window.speechSynthesis.cancel();
        }
    });

    $("#word-dropdown").change(function() {
        selectedWord = $(this).val();
        speakText("Try to say the word " + selectedWord);
    });

    $("#reset-dropdown-btn").click(function() {
        resetDropdown();
    });

    $(document).ready(function() {
        $("#toggle-tts-btn").addClass("btn-speech-off");
        setInterval(fetchPrediction, 1000);
    });
</script>

{% endblock content %}
