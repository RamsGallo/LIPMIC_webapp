{% extends 'base.html' %}

{% block title %}
    Corrective Tool
{% endblock title %}

<!-- Render header -->
{% block header %}
<!-- Navigation Bar -->

{% endblock header %}

<!-- Render content of page -->
{% block content %}
<div class="container-fluid">
    <!-- Video Feed and Prediction Row -->
    <div class="row justify-content-center my-4">
        <!-- Video Feed Column -->
        <div class="col-md-6 text-center">
            <div class="border rounded shadow-sm p-2 bg-light">
                <img src="{{ url_for('pages.video_feed') }}" class="img-fluid rounded" alt="Camera Feed">
            </div>
        </div>

        <!-- Prediction Output Column -->
        <div class="col-md-6">
            <div class="card text-center mb-4 shadow-sm">
                <div class="card-body">
                    <h2 class="card-title">Current Prediction:</h2>
                    <p id="current-prediction" class="lead text-success">None</p>
                    <hr>

                    <h4 class="card-title">Evaluation Test</h4> 
        
                    <p><strong>Select a word to practice:</strong></p>

                    <div class="d-flex">
                    <select id="word-dropdown" class="form-control">
                        <option value="" selected disabled>Select a word</option>
                        <option>Can</option>
                        <option>Hear</option>
                        <option>Hello</option>
                        <option>Help</option>
                        <option>I</option>
                        <option>Love</option>
                        <option>Need</option>
                        <option>Please</option>
                        <option>See</option>
                        <option>Speak</option>
                        <option>Watch</option>
                        <option>We</option>
                        <option>You</option>
                    </select>
                    <button id="reset-dropdown-btn" class="btn btn-secondary">Clear</button>
                    </div>

                    <audio id="ting-sound" src="https://www.myinstants.com/media/sounds/ding-sound-effect_2.mp3"></audio>
                    
                </div>
            </div>
            <button id="toggle-tts-btn" class="btn btn-primary">ðŸ”‡ Speech Off</button>
        </div>
    </div>
</div>

<!-- Add Clear Text Functionality -->
<script>
    let lastSpokenText = "";  // Store the last spoken prediction
    let ttsEnabled = false;    // TTS toggle state (default: ON)
    let selectedWord = "";    // The word selected from the dropdown

    function fetchPrediction() {
        $.getJSON("{{ url_for('pages.get_prediction') }}", function(data) {
            let prediction = data.prediction || "None";
            let sentence = formatSentence(prediction);

            if (sentence !== lastSpokenText) { 
                $("#current-prediction").text(sentence);

                if (ttsEnabled) {
                    speakText(sentence);
                }

                if (selectedWord) {
                    checkPrediction(sentence);
                }
                lastSpokenText = sentence;
            }
        });
    }

    function formatSentence(text) {
        if (!text || text.trim() === "None") return "No prediction available.";
        text = text.trim(); 
        text = text.charAt(0).toUpperCase() + text.slice(1);
        return text;
    }

    function speakText(text) {
        if (ttsEnabled && text) {
            let utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utterance);
        }
    }

    function checkPrediction(prediction) {
        let cleanPrediction = prediction.replace(/[.!?]/g, '');

        if (cleanPrediction === selectedWord) {
            document.getElementById("ting-sound").play();
            speakText("Fantastic speaking! Good job!");

            // Reset dropdown after a correct match
            setTimeout(() => {
                $("#word-dropdown").val("");
                selectedWord = "";
            }, 1000);
        } else {
            speakText("Try again");
        }
    }

    function resetDropdown() {
        $("#word-dropdown").val(""); 
        selectedWord = ""; 
        speakText("Selection cleared.");
    }

    // Toggle TTS on/off
    $("#toggle-tts-btn").click(function() {
        ttsEnabled = !ttsEnabled;
        $("#toggle-tts-btn").text(ttsEnabled ? "ðŸ”Š Speech On" : "ðŸ”‡ Speech Off");
        if (!ttsEnabled){
            window.speechSynthesis.cancel();
        } 
    });

    // Handle word selection
    $("#word-dropdown").change(function() {
        selectedWord = $(this).val();
        speakText("Try to say the word " + selectedWord);
    });

    $("#reset-dropdown-btn").click(function() {
        resetDropdown();
    });

    setInterval(fetchPrediction, 1000);
</script>

{% endblock content %}


