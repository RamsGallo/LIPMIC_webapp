{% extends 'base-console.html' %}

{% block title %}
    {{ patient.name }}'s Dashboard
{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/patient_dashboard.css') }}">

<div class="container">
    <h2 class="mb-4 dashboard-title">
        <i class="fas fa-user-circle me-2"></i>{{ patient.name }}'s Summary
    </h2>
    
<ul class="nav nav-tabs mb-3" id="patientTab" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab">
      Personal Info
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="dev-tab" data-bs-toggle="tab" data-bs-target="#dev" type="button" role="tab">
      Developmental History
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="assessment-tab" data-bs-toggle="tab" data-bs-target="#assessment" type="button" role="tab" aria-controls="assessment" aria-selected="true">
      Assessment Results
    </button>
  </li>
</ul>
<div class="tab-content" id="patientTabContent">
    <div class="tab-pane fade" id="info" role="tabpanel" aria-labelledby="info-tab">
    {% macro render_section(title, fields) %}
    <div class="card mb-3 shadow-sm border-0 rounded section-card">
        <div class="card-header py-2 px-3 bg-light section-header">
            <h6 class="mb-0 text-primary fw-bold">
                <i class="fas fa-folder-open me-2"></i>{{ title }}
            </h6>
        </div>
        <div class="card-body py-2 px-3">
            <div class="row gx-3 gy-2">
                {% for column in fields %}
                    <div class="col-md-6">
                        {% for label, value in column.items() %}
                            <div class="d-flex align-items-center mb-1">
                                <label class="form-label me-2 mb-0 text-muted small" style="min-width: 140px;">{{ label }}:</label>
                                <div class="form-control-plaintext small text-dark">{{ value }}</div>
                            </div>
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endmacro %}
        {{ render_section('Personal Information', [
            {
                "Patient Name": patient.name,
                "Age": patient.age,
                "Sex": patient.sex,
                "Date of Birth": patient.dob
            },
            {
                "Address": patient.address,
                "Religion": patient.religion,
                "Diagnosis": patient.diagnosis,
                "Date of Evaluation": patient.doe
            }
        ]) }}

        {{ render_section('Emergency & Contact Information', [
            {
                "Emergency Contact Person": patient.emergency_person,
                "Contact Number": patient.contact_no
            },
            {
                "Alternative Contact Number": patient.alt_contact_no,
                "Grade Level": patient.grade_level
            }
        ]) }}

        {{ render_section('Family Information', [
            {
                "Father's Name": patient.father_name,
                "Father's Contact Number": patient.father_contact_no,
                "Father's Medical History": patient.father_med_history
            },
            {
                "Mother's Name": patient.mother_name,
                "Mother's Contact Number": patient.mother_contact_no,
                "Mother's Medical History": patient.mother_med_history
            }
        ]) }}

        {{ render_section('Medical Information', [
            {
                "Complication during pregnancy": patient.complication_preg,
                "Medication taken": patient.med_taken,
                "Duration taken": patient.duration_med_taken,
                "Type of delivery": patient.typeOfDelivery
            },
            {
                "Complication during delivery": patient.complication_deli,
                "Birth weight": patient.birth_weight,
                "Birth problem": patient.birth_problem,
                "Medication/s": patient.medication
            }
        ]) }}
    </div>

    <div class="tab-pane fade" id="dev" role="tabpanel" aria-labelledby="dev-tab">
    {% macro render_section(title, fields) %}
    <div class="card mb-3 shadow-sm border-0 rounded section-card">
        <div class="card-header py-2 px-3 bg-light section-header">
            <h6 class="mb-0 text-primary fw-bold">
                <i class="fas fa-folder-open me-2"></i>{{ title }}
            </h6>
        </div>
        <div class="card-body py-2 px-3">
            <div class="row gx-3 gy-2">
                {% for column in fields %}
                    <div class="col-md-6">
                        {% for label, value in column.items() %}
                            <div class="d-flex align-items-center mb-1">
                                <label class="form-label me-2 mb-0 text-muted small" style="min-width: 140px;">{{ label }}:</label>
                                <div class="form-control-plaintext small text-dark">{{ value }}</div>
                            </div>
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endmacro %}
        {{ render_section('Gross Motor Skills (GMS) Age Achieved', [
            {
                "Maintains sitting": patient.gms_0,
                "Bangs objects/toys": patient.gms_1,
                "Creeping": patient.gms_2,
                "Cruises": patient.gms_3,
                "Seats self to chair": patient.gms_4,
                "Walks alone": patient.gms_5
            },
            {
                "Walks up and down the stairs": patient.gms_6,
                "Jumps with both feet": patient.gms_7,
                "Pedals tricycle": patient.gms_8,
                "Running": patient.gms_9,
                "Hops on one foot": patient.gms_10
            }
        ]) }}

        {{ render_section('Fine Motor Skills (FMS) Age Achieved', [
            {
                "Midline hand play": patient.fms_0,
                "Transfer toy from hand to hand": patient.fms_1,
                "Plays peek-a-boo": patient.fms_2,
                "Waves good bye": patient.fms_3,
                "Draws line": patient.fms_4,
            },
            {
                "Holds crayon and scribbles": patient.fms_5,
                "Draws simple figures": patient.fms_6,
                "Snips with scissors": patient.fms_7,
                "Colors in large forms": patient.fms_8,
                "Copy letters": patient.fms_9
            }
        ]) }}

        {{ render_section('Activities of Daily Living (ADL) Age Achieved', [
            {
                "Holds feeding bottle": patient.adl_0,
                "Finger-feeds": patient.adl_1,
                "Uses spoon with spillage": patient.adl_2,
                "Removes on garment": patient.adl_3

            },
            {
                "Drinks from a cup neatly": patient.adl_4,
                "Toilet trained": patient.adl_5,
                "Finds front of clothing": patient.adl_6
            }
        ]) }}

        {{ render_section('Cognitive Age Achieved', [
            {
                "Turns to voices and sounds consistently": patient.cog_0,
                "Understands simple commands": patient.cog_1,
                "Follows simple direction": patient.cog_2,
                "Points to named body part": patient.cog_3

            },
            {
                "Refers to self by name": patient.cog_4,
                "Understands contrasts or opposites": patient.cog_5,
                "Understand who, what, and where questions": patient.cog_6
            }
        ]) }}

        {{ render_section('Oral Motor Development Age Achieved', [
            {
                "Opens and closes mouth in response to food stimulus": patient.omd_0,
                "Coordinates sucking, swallowing, and breathing": patient.omd_1,
                "Suck and swallow reflex inhibited": patient.omd_2,
                "Swallows strained or pureed foods, small amounts": patient.omd_3,
                "Uses tongue to move food in mouth, up-down tongue and jaw movement": patient.omd_4

            },
            {
                "Mouths and munches solid food": patient.omd_5,
                "Bites food voluntarily": patient.omd_6,
                "Drools less except when teething or congested": patient.omd_7,
                "Chews food with coordinated movements, of tongue, jaw, lips; tongue lateralization; upper lip active": patient.omd_8,
                "Chews completely with rotary jaw movements": patient.omd_9,
            }
        ]) }}
    </div>

    <div class="tab-pane fade show active" id="assessment" role="tabpanel" aria-labelledby="assessment-tab">

        <div class="row">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show p-0" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            <!-- Assessment Results Column -->
            <div class="col-lg-7 mb-4">
                <div class="card shadow-sm border-0 rounded-3 section-card">
            <div class="card-header section-header">
                <h4 class="mb-0 section-title">
                    <i class="fas fa-chart-line me-2"></i>Assessment Results
                </h4>
            </div>
            <div class="card-body">
                <div class="accordion" id="accordionResults">
                    {% for result in results %}
                    <div class="accordion-item mb-3">
                        <h2 class="accordion-header" id="heading{{ loop.index }}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#collapse{{ loop.index }}" aria-expanded="false"
                                    aria-controls="collapse{{ loop.index }}">
                                <i class="fas fa-file-alt me-2"></i>{{ result.assessment_type | upper }} Test (ID: {{ result.id }}) |
                                {{ result.date_taken.strftime('%Y-%m-%d') }}
                            </button>
                        </h2>
                        <div id="collapse{{ loop.index }}" class="accordion-collapse collapse"
                            aria-labelledby="heading{{ loop.index }}" data-bs-parent="#accordionResults">
                            <div class="accordion-body">
                                <p class="mb-0 result-details">
                                    <span class="badge bg-white text-dark border custom-border">
                                        <strong>Date:</strong> {{ result.date_taken.strftime('%Y-%m-%d') }}
                                    </span>
                                    {% if result.assessment_type != "casl" %}
                                    <span class="badge bg-success text-light" data-bs-toggle="tooltip"
                                        title="Lip-reading model's score. The model can make mistakes.">
                                        <strong>Model Score:</strong> {{ result.score }} / {{ result.answers | length }}
                                    </span>
                                    {% endif %}
                                    <span class="badge bg-secondary text-light">
                                        <strong>Duration:</strong>
                                        {% if result.duration %}
                                            {{ (result.duration // 60) }}m {{ (result.duration % 60) }}s
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </span>
                                </p>
                                <hr>

                                {% if result.assessment_type != "casl" %}
                                {% for answer in result.answers %}
                                
                                    
                                    {% if answer.level is defined %}
                                    <strong>Difficulty:</strong> {{ answer.level|capitalize }}<br>
                                    {% endif %}
                                    {% if answer.index is defined %}
                                    <strong>Question #</strong>{{ answer.index + 1 }}. {{ answer.prompt }}<br>
                                    {% endif %}
                                    <strong>Model Prediction:</strong> {{ answer.predicted | capitalize}}<br>
                                    <!-- <strong>Correct:</strong> {{ answer.correct | capitalize }}<br> -->
                                    <div class="mt-1">
                                        {% for img in answer.images %}
                                        <img src="{{ img.src }}" alt="{{ img.direction }}" width="100" class="me-2 mb-1" />
                                        {% endfor %}
                                    </div>
                                
                                <hr>
                                {% endfor %}
                                {% endif %}

                                {% if result.assessment_type == "casl" %}
                                    {% for answer in result.answers %}
                                        {% set q_index = answer.index %}
                                        {% set level = answer.level %}
                                        <div class="question-section">
                                        <h6>Task {{ loop.index }} ({{ level }}) — {{ answer.prompt }} <strong>{{ answer.correct|capitalize }}</strong></h6>
                                        <div class="d-flex flex-wrap lip-frames-grid">
                                            {% for frame in result.lip_frames if frame.level == level and frame.question_index == q_index %}
                                            <div class="frame">
                                                <img src="{{ url_for('static', filename=frame.file_path) }}"
                                                    alt="Frame {{ frame.frame_index }}"
                                                    class="img-thumbnail m-1" width="80">
                                                <span class="frame-number">Q{{ frame.question_index }} | {{ frame.level }}</span>     
                                            </div>
                                            {% endfor %}
                                        </div>
                                        </div><br>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <p class="text-muted">No results found.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
            </div>

            <!-- Saved Goals Column -->
        <div class="col-lg-5 mb-4">
            <div class="card border-info shadow-sm">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <span>Saved Goals</span>
                    <button class="btn btn-outline-light btn-sm" data-bs-toggle="modal" data-bs-target="#goalsModal">
                        Add Intervention
                    </button>
                </div>
                <div class="card-body pt-3 py-0">
                    <div class="goals-content-scroll">
                        {% if patient.goals %}
                            {% for goal in patient.goals|reverse %}
                            <div class="mb-2 p-2 border rounded shadow-sm bg-light" id="goalItem_{{ goal.id }}">
                                <div class="d-flex justify-content-end align-items-start mb-2">
                                    <div>
                                        <a href="{{ url_for('pages.goal_report_pdf', goal_id=goal.id) }}" class="btn btn-sm btn-outline-primary me-2" target="_blank" title="Download PDF Report for this Goal"> {# Added me-2 for spacing #}
                                            PDF
                                        </a>
                                        {# NEW: Delete Button #}
                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="confirmDeleteGoal({{ goal.id }})" title="Delete this Goal">
                                            Delete
                                        </button>
                                    </div>
                                </div>

                                <p class="mb-1"><strong>Description:</strong> {{ goal.goal_text }}</p>

                                {% if goal.problem_description %}
                                    <p class="mb-1"><strong>Problem:</strong> {{ goal.problem_description }}</p>
                                {% endif %}

                                {# Display Suggested Intervention if it exists #}
                                {% if goal.intervention_text %}
                                    <p class="mb-1"><strong>Intervention:</strong></p>
                                    <div class="intervention-display mb-2">
                                        {{ goal.intervention_text | format_intervention }}
                                    </div>
                                {% endif %}

                                <small class="text-muted d-block mb-1">
                                    <b>{{ goal.assessment_result.assessment_type|upper }} (id: {{ goal.assessment_result.id }})</b>
                                    on {{ goal.assessment_result.date_taken.strftime('%Y-%m-%d') }} |
                                    Set by: {{ goal.slp.username }}
                                </small>

                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <div>
                                        <strong>Status:</strong>
                                        <span class="badge
                                            {% if goal.status == 'active' %}bg-secondary
                                            {% elif goal.status == 'achieved' %}bg-success
                                            {% elif goal.status == 'on_hold' %}bg-warning text-dark
                                            {% elif goal.status == 'discontinued' %}bg-danger
                                            {% endif %}"
                                            id="goalStatusBadge_{{ goal.id }}">
                                            {{ goal.status.replace('_', ' ').title() }}
                                        </span>
                                        {% if goal.achieved_at %}
                                            <small class="text-muted ms-2" id="goalAchievedDate_{{ goal.id }}">(Achieved: {{ goal.achieved_at.strftime('%Y-%m-%d') }})</small>
                                        {% else %}
                                            <small class="text-muted ms-2" id="goalAchievedDate_{{ goal.id }}"></small>
                                        {% endif %}
                                    </div>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-info dropdown-toggle" type="button" id="goalStatusDropdown_{{ goal.id }}" data-bs-toggle="dropdown" aria-expanded="false">
                                            Change Status
                                        </button>
                                        <ul class="dropdown-menu" aria-labelledby="goalStatusDropdown_{{ goal.id }}">
                                            <li><a class="dropdown-item" href="#" onclick="updateGoalStatus({{ goal.id }}, 'active')">Active</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="updateGoalStatus({{ goal.id }}, 'achieved')">Achieved</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="updateGoalStatus({{ goal.id }}, 'on_hold')">On Hold</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="updateGoalStatus({{ goal.id }}, 'discontinued')">Discontinued</a></li>
                                        </ul>
                                    </div>
                                </div>
                                <hr>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">No goals saved yet.</p>
                        {% endif %}
                    </div> {# End of goals-content-scroll #}
                </div>
            </div>
        </div>

        </div>

        <div class="modal fade" id="goalsModal" tabindex="-1" aria-labelledby="goalsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content shadow">
                    <div class="modal-header">
                        <h5 class="modal-title" id="goalsModalLabel"><i class="fas fa-bullseye me-2"></i>Set Goals for {{ patient.name }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    {# Add data-patient-id to the form #}
                    <form method="POST" action="{{ url_for('pages.save_goals', patient_id=patient.id) }}" id="goalsForm" data-patient-id="{{ patient.id }}">
                        <div class="mb-3 p-3 pb-1">
                            <label for="assessment_result_id" class="form-label">{{ patient.name }}'s Completed Assessment</label>
                            <select name="assessment_result_id" id="assessment_result_id" class="form-select" required>
                                <option value="">Select Assessment</option>
                                {% for result in patient.sessions|reverse %}
                                <option value="{{ result.id }}" data-assessment-type="{{ result.assessment_type }}"> {# ADD THIS: data-assessment-type #}
                                    {{ result.assessment_type|upper }} (ID: {{ result.id }}) - {{ result.date_taken.strftime('%Y-%m-%d') }} {% if result.assessment_type != 'casl' %} (Score: {{ result.score }}) {% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3 p-3 pt-1">
                            <label for="goal_text" class="form-label">Description</label>
                            <textarea name="goal_text" id="goal_text" class="form-control" rows="3" required></textarea>
                        </div>

                        <div class="mb-3 px-3">
                            <label for="problem_description" class="form-label">Problem Description</label>
                            <textarea name="problem_description" id="problem_description" class="form-control" rows="3" placeholder="Describe the specific speech/language issue... and/or Describe the lip frames captured"></textarea>
                        </div>

                        <div class="mb-3 px-3">
                            <label for="intervention_text" class="form-label">Suggested Intervention</label>
                            <textarea name="intervention_text" id="intervention_text" class="form-control" rows="3" readonly placeholder="Click 'Generate Intervention' to auto-fill"></textarea>
                        </div>

                        {# NEW SECTION FOR ASSESSMENT TYPE TOGGLE AND DISPLAY #}
                        <div class="mb-3 px-3">
                            <div class="form-check form-switch d-flex justify-content-between align-items-center">
                                <div>
                                    <input class="form-check-input" type="checkbox" id="includeAssessmentTypeToggle">
                                    <label class="form-check-label" for="includeAssessmentTypeToggle">
                                        Include Assessment Type in Intervention Suggestion
                                    </label>
                                </div>
                                <small id="selectedAssessmentTypeDisplay" class="text-muted"></small>
                            </div>
                        </div>
                        {# END NEW SECTION #}

                        <div class="mb-3 px-3 d-flex justify-content-between align-items-center">                         
                            <small class="text-muted text-start" style="max-width: 50%;">
                                This is for informational purposes only. Interventions or medical advice or a diagnosis, should be reviewed.
                            </small>
                            <div>
                                <button type="button" class="btn btn-outline-secondary me-2" onclick="generateIntervention()">
                                    <svg width="16" height="16"><use xlink:href="#stars"/></svg>Generate Intervention
                                </button>
                                <button type="submit" class="btn btn-primary">Save</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
    </div>

</div>
{% endblock content %}

{% block scripts %}
<script>
  // Initialize all tooltips
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl)
  })
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
    const assessmentResultSelect = document.getElementById('assessment_result_id');
    const selectedAssessmentTypeDisplay = document.getElementById('selectedAssessmentTypeDisplay');

    function updateAssessmentTypeDisplay() {
        const selectedOption = assessmentResultSelect.options[assessmentResultSelect.selectedIndex];
        const assessmentType = selectedOption.dataset.assessmentType; // Get the data-assessment-type attribute
        
        if (assessmentType) {
            selectedAssessmentTypeDisplay.textContent = `(${assessmentType.toUpperCase()} selected)`;
        } else {
            selectedAssessmentTypeDisplay.textContent = '';
        }
    }

    // Call on load
    updateAssessmentTypeDisplay();

    // Call on change
    assessmentResultSelect.addEventListener('change', updateAssessmentTypeDisplay);
});

    async function generateIntervention() {
        const problemDescription = document.getElementById('problem_description').value;
        const interventionTextarea = document.getElementById('intervention_text');
        const goalsForm = document.getElementById('goalsForm');
        const patientIdToSend = goalsForm.dataset.patientId;

        // NEW: Get the toggle state and selected assessment type
        const includeAssessmentType = document.getElementById('includeAssessmentTypeToggle').checked;
        const assessmentResultSelect = document.getElementById('assessment_result_id');
        const selectedOption = assessmentResultSelect.options[assessmentResultSelect.selectedIndex];
        const assessmentType = selectedOption.dataset.assessmentType; // Get the data-assessment-type

        if (!problemDescription.trim()) {
            alert('Please enter a problem description before generating an intervention.');
            return;
        }

        if (!patientIdToSend || isNaN(patientIdToSend) || parseInt(patientIdToSend) <= 0) {
            alert('Patient ID is missing or invalid. Cannot generate intervention.');
            return;
        }

        // Optional: If the toggle is on but no assessment is selected, alert user
        if (includeAssessmentType && (!assessmentType || assessmentType === '')) {
            alert('Please select an assessment if you wish to include its type in the intervention suggestion.');
            return;
        }

        interventionTextarea.value = 'Generating intervention... Please wait.';
        interventionTextarea.readOnly = true;
        const generateButton = document.querySelector('button[onclick="generateIntervention()"]');
        generateButton.disabled = true;
        generateButton.textContent = 'Generating...';

        // Construct the payload
        const payload = {
            problem_description: problemDescription,
            patient_id: parseInt(patientIdToSend)
        };

        // Conditionally add assessment_type to the payload
        if (includeAssessmentType && assessmentType) {
            payload.assessment_type = assessmentType;
        }

        try {
            const response = await fetch('/generate_intervention', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload) // Use the constructed payload
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Something went wrong on the server.');
            }

            const data = await response.json();
            let generatedText = data.intervention;

            // Existing post-processing for formatting (keep this!)
            generatedText = generatedText.replace(/(\S)(?=\d+\. )/g, '$1\n');
            generatedText = generatedText.replace(/(\d+\. [^\n]+?)(\d+\. )/g, '$1\n$2');
            generatedText = generatedText.trimStart();

            interventionTextarea.value = generatedText;

        } catch (error) {
            console.error('Error generating intervention:', error);
            interventionTextarea.value = 'Error: Could not generate intervention. ' + error.message;
            alert('Failed to generate intervention: ' + error.message);
        } finally {
            interventionTextarea.readOnly = false;
            generateButton.disabled = false;
            generateButton.textContent = 'Generate Intervention';
        }
    }

    async function updateGoalStatus(goalId, newStatus) {
        try {
            const response = await fetch(`/console/goals/${goalId}/set_status`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status: newStatus })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to update status on server.');
            }

            const data = await response.json();
            
            // --- FIX IS HERE ---
            const displayStatus = data.status.replace(/_/g, ' ').split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
            // alert(`Goal status updated to: ${displayStatus}`);
            // --- END FIX ---

            // OPTIONAL: Update the badge and date instantly without full page reload
            const statusBadge = document.getElementById(`goalStatusBadge_${goalId}`);
            if (statusBadge) {
                statusBadge.textContent = displayStatus; // Use the fixed displayStatus here
                statusBadge.className = `badge ${
                    data.status === 'active' ? 'bg-secondary' :
                    data.status === 'achieved' ? 'bg-success' :
                    data.status === 'on_hold' ? 'bg-warning text-dark' :
                    data.status === 'discontinued' ? 'bg-danger' : ''
                }`;
            }

            // Update achieved date display dynamically
            const achievedDateElement = document.getElementById(`goalAchievedDate_${goalId}`);
            if (achievedDateElement) {
                if (data.status === 'achieved' && data.achieved_at) {
                    achievedDateElement.textContent = `(Achieved: ${data.achieved_at})`;
                } else {
                    achievedDateElement.textContent = ''; // Clear the date if status is not 'achieved'
                }
            }

        } catch (error) {
            console.error('Error updating goal status:', error);
            alert('Error: ' + error.message);
        }
    }

    async function confirmDeleteGoal(goalId) {
        if (confirm('Are you sure you want to delete this goal? This action cannot be undone.')) {
            try {
                const response = await fetch(`/console/goals/${goalId}/delete`, {
                    method: 'POST', // Or 'DELETE' if you configure your Flask route for DELETE requests
                    headers: {
                        'Content-Type': 'application/json'
                    }
                    // No body needed for a simple delete by ID
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to delete goal on server.');
                }

                const data = await response.json();
                alert(data.message || 'Goal deleted successfully!');

                // Remove the goal item from the DOM
                const goalItem = document.getElementById(`goalItem_${goalId}`);
                if (goalItem) {
                    goalItem.remove();
                    // Optional: If no goals are left, display "No goals saved yet."
                    const goalsContainer = document.querySelector('.goals-content-scroll');
                    if (goalsContainer && goalsContainer.children.length === 0) {
                        goalsContainer.innerHTML = '<p class="text-muted">No goals saved yet.</p>';
                    }
                }

            } catch (error) {
                console.error('Error deleting goal:', error);
                alert('Error: ' + error.message);
            }
        }
    }
</script>

{% endblock scripts %}
