<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goal Report for Patient {{ patient.name }}</title>
    <style>
        /* Basic CSS for PDF styling - Use the same CSS as before */
        body {
            font-family: Arial, sans-serif;
            margin: 1in; /* Standard margins for printing */
            font-size: 11pt;
            line-height: 1.5;
            color: #333;
        }
        h1, h2, h3, h4 {
            color: #2c3e50;
            margin-top: 1em;
            margin-bottom: 0.5em;
        }
        h1 { font-size: 18pt; text-align: center; }
        h2 { font-size: 14pt; }
        h3 { font-size: 12pt; }

        .report-section {
            margin-bottom: 1.5em;
            padding-bottom: 1em;
            border-bottom: 1px solid #eee;
        }
        .report-section:last-child {
            border-bottom: none;
        }

        .goal-item {
            margin-bottom: 1em;
            padding: 0.8em;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        .goal-item p {
            margin-bottom: 0.5em;
        }
        .goal-item strong {
            color: #555;
        }

        .intervention-display {
            white-space: pre-wrap; /* Preserves whitespace and line breaks for intervention text */
            background-color: #e6f7ff; /* Light blue background */
            padding: 0.7em;
            border-left: 3px solid #3498db; /* Blue left border */
            font-family: monospace; /* Monospace font for code/structured text */
            font-size: 10pt;
            margin-top: 0.5em;
            border-radius: 3px;
        }

        .assessment-details, .lipframe-details {
            font-size: 10pt;
            color: #666;
            margin-top: 0.5em;
            padding-left: 1em;
            border-left: 2px solid #ccc;
        }

        /* xhtml2pdf specific page breaking: */
        @page {
            size: A4; /* Or Letter, etc. */
            margin: 1in;
        }
        .page-break {
            page-break-before: always;
        }

        /* Status badge styles */
        .badge {
            display: inline-block;
            padding: 0.25em 0.4em;
            font-size: 75%;
            font-weight: 700;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.25rem;
            color: #fff; /* Default text color for badges */
        }
        .badge.bg-secondary { background-color: #6c757d; }
        .badge.bg-success { background-color: #28a745; }
        .badge.bg-warning { background-color: #ffc107; color: #333;} /* Text dark for warning */
        .badge.bg-danger { background-color: #dc3545; }
        .badge.bg-info { background-color: #17a2b8; }
        .badge.text-dark { color: #343a40 !important; } /* Override default badge text color */

        /* Table for lip frames if you decide to list them */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1em;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <h1>Goal and Assessment Report</h1>
    <h2>Patient: {{ patient.name }} (DOB: {{ patient.dob }})</h2>
    <p>Generated by: {{ slp.username }} on {{ current_time.strftime('%Y-%m-%d %H:%M') }}</p>

    <hr>

    <div class="report-section">
        <h3>Goal Details</h3>
        <div class="goal-item">
            <p><strong>Description:</strong> {{ goal.goal_text }}</p>

            {% if goal.problem_description %}
                <p><strong>Problem:</strong> {{ goal.problem_description }}</p>
            {% endif %}

            {% if goal.intervention_text %}
                <p><strong>Intervention:</strong></p>
                <div class="intervention-display">
                    {# Assuming format_intervention is available or you handle formatting here #}
                    {{ goal.intervention_text | format_intervention }}
                </div>
            {% endif %}

            <p>
                <strong>Status:</strong>
                <span class="badge
                    {% if goal.status == 'active' %}bg-secondary
                    {% elif goal.status == 'achieved' %}bg-success
                    {% elif goal.status == 'on_hold' %}bg-warning text-dark
                    {% elif goal.status == 'discontinued' %}bg-danger
                    {% endif %}">
                    {{ goal.status.replace('_', ' ').title() }}
                </span>
                {% if goal.achieved_at %}
                    <small>(Achieved: {{ goal.achieved_at.strftime('%Y-%m-%d') }})</small>
                {% endif %}
            </p>
            <p><small class="text-muted">Set on: {{ goal.created_at.strftime('%Y-%m-%d') }}</small></p>
        </div>
    </div>

    <!-- {% if assessment_result %}
     <div class="report-section">
        <h3>Associated Assessment Result</h3>
        <div class="assessment-details">
            <p><strong>Assessment Type:</strong> {{ assessment_result.assessment_type|upper }} (ID: {{ assessment_result.id }})</p>
            <p><strong>Date Taken:</strong> {{ assessment_result.date_taken.strftime('%Y-%m-%d %H:%M') }}</p>
            <p><strong>Score:</strong> {{ assessment_result.score }}</p>
            {% if assessment_result.duration %}
                <p><strong>Duration:</strong> {{ assessment_result.duration }} minutes</p>
            {% endif %}
            
            <h4>Answers:</h4>
            <table>
                <thead>
                    <tr>
                        <th>Prompt</th>
                        <th>Predicted</th>
                        <th>Correct</th>
                    </tr>
                </thead>
                <tbody>
                    {% for answer in assessment_result.answers %}
                    <tr>
                        <td>{{ answer.prompt }}</td>
                        <td>{{ answer.predicted }}</td>
                        <td>{{ 'Yes' if answer.correct else 'No' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    {% if lip_frames %}
    <div class="report-section">
        <h3>Associated Lip Frames</h3>
        <div class="lipframe-details">
            <p>This section lists image file paths for specific lip frames associated with this assessment result.</p>
            <table>
                <thead>
                    <tr>
                        <th>Question Index</th>
                        <th>Level</th>
                        <th>Frame Index</th>
                        <th>File Path</th>
                    </tr>
                </thead>
                <tbody>
                    {% for frame in lip_frames %}
                    <tr>
                        <td>{{ frame.question_index }}</td>
                        <td>{{ frame.level }}</td>
                        <td>{{ frame.frame_index }}</td>
                        <td>{{ frame.file_path }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %} -->

    <div style="text-align: center; margin-top: 2em; font-size: 9pt; color: #777;">
        --- End of Report ---
    </div>

</body>
</html>