<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIPMIC | {% block title %}{% endblock title %}</title>

    <!-- Bootstrap 5 & jQuery -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/body-console.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/about.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/assess.css') }}">
</head>
<body>

<!-- SVG Icons -->
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="overview" viewBox="0 0 16 16">
    <path d="M3 4.5h10a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2zm-2-2a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13A.5.5 0 0 1 1 2zm0 12a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13A.5.5 0 0 1 1 14z"/>
  </symbol>
  <symbol id="open-page" viewBox="0 0 16 16">
    <path d="M8.636 3.5a.5.5 0 0 0-.5-.5H1.5A1.5 1.5 0 0 0 0 4.5v10A1.5 1.5 0 0 0 1.5 16h10a1.5 1.5 0 0 0 1.5-1.5V7.864a.5.5 0 0 0-1 0V14.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h6.636a.5.5 0 0 0 .5-.5z"/>
    <path d="M16 .5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h3.793L6.146 9.146a.5.5 0 1 0 .708.708L15 1.707V5.5a.5.5 0 0 0 1 0z"/>
  </symbol>
  <symbol id="add_patient" viewBox="0 0 16 16">
    <path d="M12.5 16a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7m.5-5v1h1a.5.5 0 0 1 0 1h-1v1a.5.5 0 0 1-1 0v-1h-1a.5.5 0 0 1 0-1h1v-1a.5.5 0 0 1 1 0m-2-6a3 3 0 1 1-6 0 3 3 0 0 1 6 0M8 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4"/>
    <path d="M8.256 14a4.5 4.5 0 0 1-.229-1.004H3c.001-.246.154-.986.832-1.664C4.484 10.68 5.711 10 8 10q.39 0 .74.025c.226-.341.496-.65.804-.918Q8.844 9.002 8 9c-5 0-6 3-6 4s1 1 1 1z"/>
  </symbol>
  <symbol id="sign_out" viewBox="0 0 16 16">
    <path d="M6 12.5a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-9a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v2a.5.5 0 0 1-1 0v-2A1.5 1.5 0 0 1 6.5 2h8A1.5 1.5 0 0 1 16 3.5v9a1.5 1.5 0 0 1-1.5 1.5h-8A1.5 1.5 0 0 1 5 12.5v-2a.5.5 0 0 1 1 0z"/>
    <path d="M.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L1.707 7.5H10.5a.5.5 0 0 1 0 1H1.707l2.147 2.146a.5.5 0 0 1-.708.708z"/>
  </symbol>
  <symbol id="assessment_logo" viewBox="0 0 16 16">
    <path d="M3.5 2a.5.5 0 0 0-.5.5v12a.5.5 0 0 0 .5.5h9a.5.5 0 0 0 .5-.5v-12a.5.5 0 0 0-.5-.5H12a.5.5 0 0 1 0-1h.5A1.5 1.5 0 0 1 14 2.5v12a1.5 1.5 0 0 1-1.5 1.5h-9A1.5 1.5 0 0 1 2 14.5v-12A1.5 1.5 0 0 1 3.5 1H4a.5.5 0 0 1 0 1z"/>
    <path d="M10 .5a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5.5.5 0 0 1-.5.5.5.5 0 0 0-.5.5V2a.5.5 0 0 0 .5.5h5A.5.5 0 0 0 11 2v-.5a.5.5 0 0 0-.5-.5.5.5 0 0 1-.5-.5"/>
  </symbol>

  <symbol id="hamburger" viewBox="0 0 16 16">
    <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5"/>
  </symbol>
</svg>

<!-- Layout -->
<!-- Sidebar Toggle Button (always visible) -->
<button class="btn btn-outline-primary position-fixed top-0 start-0 m-3 z-3" type="button"
        data-bs-toggle="offcanvas" data-bs-target="#sidebarConsole" aria-controls="sidebarConsole">
  <i class="fas fa-bars"><svg width="20" height="20"><use xlink:href="#hamburger"/></svg></i>
</button>

<!-- Offcanvas Sidebar -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarConsole" aria-labelledby="sidebarConsoleLabel">
  <div class="offcanvas-header border-bottom">
    <h5 class="offcanvas-title fw-semibold d-flex align-items-center" id="sidebarConsoleLabel">
      <a href="{{ url_for('pages.index_page') }}" class="text-decoration-none"><img src="{{ url_for('static', filename='img/logo-3.png') }}" alt="Lipmic Logo" height="26" class="me-2">
      Lipmic
      </a>
    </h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body d-flex flex-column justify-content-between">
    <div>
      <ul class="list-unstyled">
        <li class="mb-3">
          <p class="text-uppercase text-muted fw-semibold small mb-1">Home</p>
          <a href="{{ url_for('pages.console_page') }}" class="d-flex align-items-center text-dark text-decoration-none px-2 py-2 rounded hover-bg">
            <svg class="me-2" width="20" height="20"><use xlink:href="#overview"/></svg> Overview
          </a>
        </li>
        <li class="mb-3">
          <p class="text-uppercase text-muted fw-semibold small mb-1">Assessment</p>
          <a href="{{ url_for('pages.assessments_page') }}" class="d-flex align-items-center text-dark text-decoration-none px-2 py-2 rounded hover-bg">
            <svg class="me-2" width="20" height="20"><use xlink:href="#assessment_logo"/></svg> Tests
          </a>
        </li>
        <li class="mb-3">
          <p class="text-uppercase text-muted fw-semibold small mb-1">Account</p>
          <a href="{{ url_for('pages.add_patient') }}" class="d-flex align-items-center text-dark text-decoration-none px-2 py-2 rounded hover-bg">
            <svg class="me-2" width="20" height="20"><use xlink:href="#add_patient"/></svg> Add Patient
          </a>
          <a href="{{ url_for('pages.logout') }}" class="d-flex align-items-center text-dark text-decoration-none px-2 py-2 rounded hover-bg">
            <svg class="me-2" width="20" height="20"><use xlink:href="#sign_out"/></svg> Sign Out
          </a>
        </li>
      </ul>
    </div>
  </div>
</div>
            {% block header %}{% endblock header %} 
            
        </header>

        <div class="content flex-grow-1 ps-5">
        <main>
        {% block content %}{% endblock content %}
    </main>
</div>

<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
 <script>
(function () {
    'use strict';
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    tooltipTriggerList.forEach(function (tooltipTriggerEl) {
        new bootstrap.Tooltip(tooltipTriggerEl)
    })
})();
</script>

<script>
const toggleSidebarBtn = document.getElementById('toggleSidebar');
const sidebar = document.getElementById('sidebar-console');

toggleSidebarBtn?.addEventListener('click', () => {
  sidebar?.classList.toggle('collapsed');
});
</script>

<script>
const instructions = {
  peabody: `You are about to begin the Peabody Picture Vocabulary Test. You will see four pictures on the screen. Listen carefully to the spoken word and choose the label of picture that best represents that word by saying it aloud.`,
  casl: `You are about to begin the Comprehensive Assessment of Spoken Language test. You will be asked various questions that measure your expressive and receptive language skills. Respond clearly so your answers can be analyzed.`,
};

let selectedAssessment = null;
let selectedPatientId = null;

// Track modal instance and TTS
let ttsUtterance = null;
let bootstrapModal = null;

function speakText(text) {
  if ('speechSynthesis' in window) {
    stopTTS(); // stop any previous speech first

    const utterance = new SpeechSynthesisUtterance(text);
    utterance.rate = 1.1; // Slightly faster
    utterance.pitch = 1.7; // Higher pitch for energy

    // Select a female-sounding English voice
    const voices = speechSynthesis.getVoices();
    let preferredVoice = voices.find(voice =>
      /female|zira|samantha|victoria|google uk english female/i.test(voice.name) && /en/i.test(voice.lang)
    );

    // Fallback to first English voice
    if (!preferredVoice) {
      preferredVoice = voices.find(voice => /en/i.test(voice.lang));
    }

    if (preferredVoice) {
      utterance.voice = preferredVoice;
    }

    ttsUtterance = utterance;
    speechSynthesis.speak(ttsUtterance);
  }
}


function stopTTS() {
  if ('speechSynthesis' in window && ttsUtterance) {
    window.speechSynthesis.cancel();
    ttsUtterance = null;
  }
}

document.querySelectorAll('.horizontal-card').forEach(card => {
  const patientSelect = card.querySelector('.patient-select');
  const startButton = card.querySelector('.start-assessment-btn');

  // Show the button when a patient is selected
  patientSelect.addEventListener('change', () => {
    if (patientSelect.value) {
      startButton.classList.remove('d-none');
    } else {
      startButton.classList.add('d-none');
    }
  });

  // On Start Button Click â€” show modal, not redirect
  startButton.addEventListener('click', async () => {
    selectedPatientId = patientSelect.value;
    selectedAssessment = startButton.dataset.assessment;

    if (!selectedPatientId) {
      alert("Please select a patient first.");
      return;
    }

    // Send patient to backend (optional if session logic needs it)
    const response = await fetch("/set_patient_by_id", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ patient_id: selectedPatientId })
    });

    const data = await response.json();
    if (!data.success) {
      alert("Error selecting patient. Please try again.");
      return;
    }

    // Show modal with TTS
    const text = instructions[selectedAssessment] || "Please follow the on-screen instructions.";
    document.getElementById('instructionText').textContent = text;
    speakText(text);

    bootstrapModal = new bootstrap.Modal(document.getElementById('instructionModal'));
    bootstrapModal.show();
  });
});

// Modal continue button redirect
document.getElementById('continueAssessmentBtn').addEventListener('click', () => {
  stopTTS();
  if (selectedAssessment && selectedPatientId) {
    window.location.href = `/console/assessments/${selectedAssessment}?patient_id=${selectedPatientId}`;
  }
});

// Modal close button safety
document.querySelector('#instructionModal .btn-close')?.addEventListener('click', stopTTS);
document.querySelector('#instructionModal .btn-secondary')?.addEventListener('click', stopTTS);
</script>

<script>const patientId = "{{ patient_id }}";</script>

<script src="{{ url_for('static', filename='js/ckeditor/ckeditor.js') }}"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
      // Wait for modal to be shown
      var modal = document.getElementById('goalsModal');
      if (modal) {
          modal.addEventListener('shown.bs.modal', function () {
              // Only initialize CKEditor if not already done
              if (!CKEDITOR.instances['goal_text']) {
                  CKEDITOR.replace('goal_text');
              }
          });
      }
  });
</script>

{% block scripts %}

{% endblock scripts %} 

</body>
</html>
